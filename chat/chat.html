<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<!-- Viewport metatags -->
	<meta name="HandheldFriendly" content="true" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<!-- iOS webapp metatags -->
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />

	<!-- iOS webapp icons -->
	<link rel="apple-touch-icon-precomposed" href="assets/images/ios/fickle-logo-72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/images/ios/fickle-logo-72.png" />
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/images/ios/fickle-logo-114.png" />

	<!--<link rel="shortcut icon" href="assets/images/ico/fab.ico">-->
	<title>人工客服工作台</title>

	<link href="assets/css/bootstrap.min.css" rel="stylesheet">
	<link href="assets/css/bootstrap-switch.css" rel="stylesheet">
	<link href="assets/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="assets/css/plugins/amaranjs/jquery.amaran.css" rel="stylesheet">
	<link href="assets/css/plugins/amaranjs/theme/all-themes.css" rel="stylesheet">
	<link href="assets/css/plugins/jquery.remodal.css" rel="stylesheet">
	<link href="assets/css/jquery.Jcrop.css" rel="stylesheet">
	<link href="assets/css/style.css" rel="stylesheet">
	<link href="assets/css/responsive.css" rel="stylesheet">
	<link href="css/webchat.css?v=151027" rel="stylesheet">
	<link href="css/webchat4.0.css" rel="stylesheet">

	<script type="text/javascript">
		window.onbeforeunload = function(e) {
			 return "";
		}

		setInterval(function(){
			if (window.errorCount >= 5) {
				document.write('');
				alert('暂时与服务器断开连接,点击确定重新加载页面');
				location.reload();
				return;
			}
		}, 10000)

		// if (!window.WebSocket){

		// }
	</script>
	<!-- 初始化emoji -->
	<script src="http://cdn.bootcss.com/twemoji/1.4.1/twemoji.min.js"></script>
</head>
<body style="min-width: 1155px">
<section id="top-bar">
	<div class="top-bar-logo">
		<img src="assets/images/logo.png" alt=""/>
		<span>智齿客服</span>
	</div>
</section>
<section id="main-container" >
	<section id="left-navigation">
		<header class="dropdown header-box-yy">
			<div id="user_menu">
				<div data-toggle="dropdown" class="menuDropdown">
					<div id="current_user_avatar">
						<img class="member_image thumb_48 logo" src="" id="mylogo">
					</div>
					<span id="current_user_name" class="overflow_ellipsis"></span>
					<img id="connection_icon" src="img/busy.png" class="">
					<span id="connection_style">工单客服</span>
					<span id="connection_status" style="display:none">离线</span>
				</div>
				<div class="dropdown-menu dropdown-menu-right menu status-user">
					<ul>
						<!-- 							<li data-toggle="modal" data-target="#setting" id="gotoSetYourInfo" onclick="resetInfoForm()">个人设置</li> -->


						<li onclick="line()" id="user_online" >
							<span class="user-icon-online">在线</span>
						</li>
						<li onclick="busy()" id="user_busy" >
							<span class="user-icon-busy">忙碌</span>
						</li>
						<li onclick="offline()" id="user_offline" >
							<span class="user-icon-offine">离线</span>
						</li>
						<!-- 							<li data-toggle="modal" data-target="#settingg" id="gotoSetYourInfoo" onclick="resetInfoFormtoo()">数据统计</li> -->
					</ul>
				</div>
			</div>
			<div id = "admin_Invite" class="joinBox-yy">
				<a href="javascript:;" id="openOtherUser">
					<i></i>
					<span>邀请新用户</span>
				</a>
				<div id="waitNum" style="">

				</div>
			</div>
		</header>
		<ul class="mainNav">
			<li>
				<ul class="nav nav-tabs" id="main_tab">
					<li class="active" style="width: 144px;"><a href="#chatonline" data-toggle="tab">在线会话</a></li>
					<li class="" style="float: right;"><a href="#history" onclick="historyTabClick()" data-toggle="tab"> 历史记录</a></li>
					<li class="hide"><a href="#blacklist" onclick="return" data-toggle="tab"> 来访客户</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active leftScroll"  id="chatonline">
						<ul id="users"></ul>
						<ul id="offlineUser"></ul>
					</div>
					<div class="tab-pane " id="history" style="overflow-y: hidden; outline: none;  padding: 0px; ">
						<div class="radio-inline radio-box-yy">
							<label class="radio-inline" onclick="getUserListByType('1')">
								<div class="c-redio c-redio-noActive" id="optionsRadios3" value="1" ></div>
								<!-- <input type="radio" name="utypeRadios" id="optionsRadios3" value="1" onclick="getUserListByType('1')" checked="checked"> -->
								<span>全部</span>
							</label>
							<label class="radio-inline" onclick="getUserListByType('2')">
								<div class="c-redio c-redio-noActive" id="optionsRadios3" value="2" ></div>
								<!-- <input type="radio" name="utypeRadios" id="optionsRadios4" value="2" onclick="getUserListByType('2')"> -->
								星标
							</label>
							<label class="radio-inline" onclick="getUserListByType('3')">
								<div class="c-redio c-redio-noActive" id="optionsRadios3" value="3" ></div>
								<!-- <input type="radio" name="utypeRadios" id="optionsRadios5" value="3" onclick="getUserListByType('3')"> -->
								黑名单
							</label>
						</div>
						<div id="historylist" class="leftScroll" tabindex="1">
							<ul id="historyusers" style="border-top: 0px solid #ddd;">
								<li id="historyuser_267yhw37">
									<a href="javascript:;" class="user" cid="267yhw37" name="yhw37" uid="267yhw37">
										<i class="fa fa-laptop"></i>
										<span class="uname">yhw37</span>
										<span class="badge" style="right: 0px;background: transparent;">[10:42]</span>
										<span class="ohide">yhw37</span>
									</a>
								</li>
							</ul>
						</div>
					</div>
					<div class="tab-pane leftScroll" id="blacklist" style="overflow-y: hidden; outline: none;  ">
						<ul id="blackusers">
						</ul>
					</div>

				</div>
			</li>
		</ul>
	</section>

	<section id="min-wrapper">
		<div id="main-content">
			<div class="container-fluid" >
				<div class="row chatCont" id="chatlist">
					<div class="col-md-8 col-xs-8 chat" style="padding: 0px;display:none;min-width: 575px" id="chat">
						<header class='clearfix'>
							<span style="margin-left: 15px;cursor: pointer;color: #555459;font-weight: 900;float:left" class="chat_user_title"></span>
							<!--<div class="addButton">-->
								<!--<a href="javascript:;" class="goOut" onclick="goZhuan()"><i class="fa fa-sign-out"></i>转接</a>-->
								<!--<a href="javascript:;" class="goOut" onclick="goBlack()"><i class="fa fa-minus-circle"></i>拉黑</a>-->
								<!--<a href="javascript:;" class="goOut addstar hide" onclick="addStarMark()"><i class="fa fa-star-o"></i>加星标</a>-->
								<!--<a href="javascript:;" class="goOut deldestar hide" onclick="removeStarMark()"><i class="fa fa-star"></i></a>-->
							<!--</div>-->
							<div class="addButton" >
								<a href="javascript:;" class="goOut addstar hide" onclick="addStarMark()"><i class="fa fa-star-o"></i>星标</a>
								<a href="javascript:;" class="goOut deldestar hide" onclick="removeStarMark()"><i class="fa fa-star"></i>已标记</a>
								<a href="javascript:;" class="goOut addblack hide" onclick="goBlack()"><i class="fa fa-minus-circle"></i>拉黑</a>
								<a href="javascript:;" class="goOut delblack hide" onclick="removeBlack()"><i class="fa fa-minus-circle"></i>解除拉黑</a>
								<a href="javascript:;" class="goOut transfer" onclick="goZhuan()"><i class="fa fa-share"></i>转接</a>
							</div>

						</header>
						<div class="scrollBoxParent">
							<div class="panel-body scrollBox">
							</div>
						</div>
						<div  style="position:absolute; bottom:0px;width:100%" class="botTextBox">
							<div class="uesrDivNow">
								<p><span class="callText"></span><a href="javascript:;" class="callBtn">电话回拨</a></p>
							</div>
							<p class="userTextNow"></p>
	                        		<span class="faceButton" >
	                        				<!--<i class="fa fa-meh-o face"  style="font-size: 20px"></i>-->
										<i class="fa face faceIcon" style="font-size:20px"></i>
										<i id="maskFace"></i>
									</span>
									<span class="picButton" >
	                        				<!--<i class="fa fa-photo upload" style="font-size: 20px"></i>-->
										<i id="maskPhoto"></i>
										<i class="photoTag fa  upload" style="font-size: 20px"></i>

									</span>
							<textarea class="animatedTextArea form-control msg-send-input sendMessage" maxlength="1024"  placeholder="请输入.." style="resize: none;max-height: 54px;"  robot="other" ></textarea>
							<div><button   class="btnSend" id="btnSend" type="button">发送</button></div>
						</div>
					</div>
					<div class="col-md-8 col-xs-8 chat" style="padding: 0px;display:none;min-width: 575px" id="hchat" >
						<header class='clearfix'>
							<!--原型目前没有-yyy-->
							<!--<span style="margin-left: 15px;cursor: pointer;color: #555459;font-weight: 900;float:left" class="chat_user_title"></span>-->
							<div class="addButton" >
								<a href="javascript:;" class="goOut addstar hide" onclick="addStarMark(true)"><i class="fa fa-star-o"></i>星标</a>
								<a href="javascript:;" class="goOut deldestar hide" onclick="removeStarMark(true)"><i class="fa fa-star"></i>已标记</a>
								<a href="javascript:;" class="goOut addblack hide" onclick="goBlack(true)"><i class="fa fa-minus-circle"></i>拉黑</a>
								<a href="javascript:;" class="goOut delblack hide" onclick="removeBlack(true)"><i class="fa fa-minus-circle"></i>解除拉黑</a>
								<a href="javascript:;" class="goOut transfer" onclick="goZhuan()"><i class="fa fa-share"></i>转接</a>
							</div>
						</header>
						<div class="scrollBoxParent">
							<div class="panel-body scrollBox">
							</div>
						</div>

					</div>
					<div class="col-md-4 col-xs-4 right" style="min-width: 285px">
						<div class="rightBox">
							<div class="panel-header-other" style="display: none">
								<div class="otherItem">
									<i class="fa fa-align-left"></i>
									<span>其他</span>
								</div>
								<div class="otherItem">
									<i class="fa fa-align-left"></i>
									<span>其他</span>
								</div>
							</div>
							<div class="panel-body" style="display: block;">
								<!-- Nav tabs -->
								<ul class="nav nav-tabs icon-tab">
									<li class="active"><a href="#profileuser" id="goProfileuser" data-toggle="tab"><i class="fa fa-user1"></i> <span>客户资料</span></a></li>
									<li class=""><a href="#messagesuser" id="goMessage" data-toggle="tab"><i class="glyphicon glyphicon-comment1"></i> <span>快捷回复</span></a></li>
									<li class=""><a href="#homeuser" id="gotoQuick" data-toggle="tab"><i class="fa fa-comments-o1"></i> <span>智能回复</span></a></li>
									<li class="" style="display: none"><a id="ordersearch" href="javascript:;" data-toggle="tab"><i class="fa fa-file-text1"></i> <span>工单查询</span></a></li>
									<li class="dropdown clearfix hide" id="clientSystems" >
										<a class=" dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="false" aria-expanded="false">
											<i class="fa fa-navicon1"></i> <span>客户系统</span>
											<span style="display: none" class="caret"></span>
										</a>
										<!--把此ul写到js中去了-->
										<!--<ul class="dropdown-menu dropdown-menu-right ifList" aria-labelledby="dropdownMenu2">-->
										<!--</ul>-->
									</li>
								</ul>
								<!-- Tab panes -->
								<div class="tab-content tab-border">
									<div class="tab-pane fade active in" id="profileuser">
										<h4>访问信息</h4>
										<ul>
											<li>
												<div class="userTypeName">对话页：</div><a style="color: #0d81c0; font-size:14px;text-decoration:none; " target="_blank" oType="visitUrl"  class="userInp"></a>
											</li>
											<li>
												<div class="userTypeName">浏览器：</div><p  oType="browser" class="userInp" style="display:inline-block;"></p>
											</li>
											<li>
												<!--<div class="userTypeName">系  统：</div><i></i><p oType="os" class="userInp" style="color:#8d8d8d;display: inline-block;"></p>-->
												<div class="userTypeName">系  统：</div><p oType="os" class="userInp" style="display: inline-block;"></p>
											</li>
										</ul>
										<h4 style="margin-top: 40px;">用户信息</h4>
										<ul>
											<li class="clear">
												<div class="userTypeName">昵称：</div>
												<input type="text" class="userInp otherBorder" oType="nick" placeholder="_">
												<span class="tip">不能超过28个字符</span>
												<!-- <span class="tip">用户名不能为空</span> -->
											</li>
											<li class="clear">
												<div class="userTypeName">姓名：</div>
												<input type="text" class="userInp otherBorder userNameDyy " oType="uname" placeholder="_">
												<span class="tip">不能超过28个字符</span>
												<!-- <span class="tip">用户名不能为空</span> -->
											</li>
											<!--<li class="clear">-->
												<!--<div class="userTypeName">年龄：</div>-->
												<!--<input type="text" class="userInp otherBorder" oType="age" placeholder="_">-->
												<!--<span class="tip">输入格式有误</span>-->
												<!--&lt;!&ndash; <span class="tip">用户名不能为空</span> &ndash;&gt;-->
											<!--</li>-->
											<li class="clear">
												<div class="userTypeName">性别：</div>
												<select class="userInp otherBorder" oType="sex" id="sex" style="width:80px;">
													<option value="">未知</option>
													<option value="0">男</option>
													<option value="1">女</option>
												</select>
											</li>
											<li>
												<div class="userTypeName">电话：</div>
												<input type="text" class="userInp otherBorder" oType="tel" placeholder="_">
												<span>请重新修改或置空</span>
											</li>
											<li>
												<div class="userTypeName">邮箱：</div>
												<input type="text" class="userInp otherBorder" oType="email" placeholder="_">
												<span class="tip">格式不正确</span>
											</li>

											<li>
												<div class="userTypeName">Q Q：</div>
												<input type="text" class="userInp otherBorder" oType="qq" placeholder="_">
												<span>请重新修改或置空</span>
											</li>

											<li>
												<div class="userTypeName">微信：</div>
												<input type="text" class="userInp otherBorder" oType="weixin" placeholder="_">
												<span>请重新修改或置空</span>
											</li>
											<li>
												<div class="userTypeName">微博：</div>
												<input type="text" class="userInp otherBorder" oType="weibo" placeholder="_">
												<span>请重新修改或置空</span>
											</li>
											<li>
												<div class="userTypeName remarkTip">备注：</div>
												<div class="remarkTxt ">
													<textarea   class="userInp othe remark form-control" maxlength="200" oType="remark" placeholder="上限200字"></textarea>

												</div>

											</li>
										</ul>

									</div>

									<div class="tab-pane fade tab-home-yy" id="messagesuser">
										<div class="rightQuick row">
											<div class="col-md-4 col-xs-4 rightQuickLeft">
												<ul>
												</ul>
											</div>
											<div class="col-md-8 col-xs-8 rightQuickRight">
												<ul>
												</ul>
											</div>
										</div>
										<div class="quickBtnP">
											<a href="javascript:;" id="shortcut">
												<i class="fa fa-cog"></i>
												<span>设置快捷回复内容</span>
											</a>
										</div>
									</div>

									<div class="tab-pane fade" id="homeuser">
										<p><input type="text" id="quickSerch" placeholder="搜索"><a href="javascript:;" id="quickSerchBtn">搜索</a></p>
										<div class="homeUserBox">
											<p class="robotHideBtn"><a href="javascript:;">&lt;返回</a></p>
											<p class="robotHide1">搜索结果：<a href="javascript:;" class="quickSendBtn">直接发送</a></p>
											<p class="robotAnswer">
												<a href="javascript:;"></a>
											</p>
											<div class="robotSugguestions">
												<p class="robotHide2">相关搜索：</p>
												<ul>

												</ul>
											</div>
										</div>
									</div>
									<div class="tab-pane fade" id="clientSystem" style="padding: 0px">
										<iframe id="clientSysIframe" style="border:0;height:100%;width:100%" scrolling="show"></iframe>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>   <!--  main-content -->
	</section>
</section>

<div class="remodal label-red white" data-remodal-id="remodal_onffline" id="remodal_onffline">
	<p>请确定是否要下线？</p><br>
	<a class="remodal-cancel btn-danger btn" href="#">取消</a>
	<a class="remodal-confirm ls-light-green-btn btn" href="#" onclick="out();return false;">确认</a>
</div>


<div class="modal fade" id="setting" tabindex="-1" role="dialog" aria-labelledby="setting" aria-hidden="true">
	<div class="modal-dialog  modal-lg">
		<div class="modal-content">
			<div class="modal-header label-light-green white">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">个人设置</h4>
			</div>
			<div class="modal-body" style="padding: 0px">
				<div class="panel" >
					<div class="panel-body">
						<!-- Nav tabs -->
						<ul class="nav nav-tabs icon-tab" id="userinfo_tab">
							<li class="active"><a href="#logo" data-toggle="tab"><i class="fa fa-user"></i> <span>头像设置</span></a></li>
							<li ><a href="#personinfo" id="toSetYourInfo" onclick="gerUserinfoByid()" data-toggle="tab"><i class="fa fa-reorder"></i> <span>个人信息</span></a></li>
							<li ><a href="#updatepassword" data-toggle="tab"><i class="fa fa-asterisk"></i> <span>修改密码</span></a></li>
						</ul>

						<!-- Tab panes -->
						<div class="tab-content tab-border">
							<div class="tab-pane fade in active" id="logo">
								<div class="row form-horizontal">
									<!--Image Cropper Wrap Start-->
									<!--Image Crops Start-->
									<div class="col-md-8" id="logo_src" style="display: none">
										<h4 class="ls-header">原图:</h4>
										<div id="jcrop_target"></div>
									</div>
									<div class="col-md-4"  >
										<h4 class="ls-header">头像:</h4>
										<div id="preview"/>
										<img src="" class="previewLogo" />
									</div>
									<div style="clear: both;margin-top: 10px">
										<button id="logo_btn" type="button" class="btn btn-warning" style="clear: both;">选择新图片</button>
										<button type="button" class="btn ls-light-green-btn" style="clear: both;display: none" onclick="setLogo()" id="setLogoBtn" >确认裁剪</button>
									</div>
								</div>
								<input type="hidden" id="logourl" />
								<input type="hidden" id="logox" />
								<input type="hidden" id="logoy" />
								<input type="hidden" id="logow" />
								<input type="hidden" id="logoh"  />
							</div>
						</div>

						<div class="tab-pane fade " id="personinfo">
							<form  id="personinfoform" class="form-horizontal">
								<div class="ls_divider">
									<div class="form-group">
										<label class="col-md-3 control-label">真实姓名：</label>
										<div class="col-md-6">
											<input type="text" class="form-control" id="staffName" name="staffName" placeholder="输入真实姓名">
										</div>
									</div>
								</div>
								<div class="ls_divider">
									<div class="form-group">
										<label class="col-md-3 control-label">客服昵称：</label>
										<div class="col-md-6">
											<input type="text" class="form-control" id="nickName"  name="nickName" placeholder="输入客服昵称">
										</div>
									</div>
								</div>
								<div class="ls_divider">
									<div class="form-group">
										<label class="col-md-3 control-label">电话：</label>
										<div class="col-md-6">
											<input type="text" class="form-control" id="phone_num"  name="phone_num" placeholder="电话或手机 用于语音通话">
										</div>
									</div>
								</div>
								<div class="ls_divider" style="display:none">
									<div class="form-group">
										<label class="col-md-3 control-label">最大接待量：</label>
										<div class="col-md-6">
											<input type="text" class="form-control" id="maxServiceCount"  name="maxServiceCount" placeholder="请输入最大接待量">
										</div>
									</div>
								</div>
								<div class="form-group">
									<div class="col-sm-offset-3 col-sm-10" style="margin-top: 10px">
										<button type="submit" onclick=" savePersoninfo();return false;" class="btn btn-success btn-lg" >保存</button>
									</div>
								</div>

							</form>
						</div>

						<div class="tab-pane fade" id="updatepassword">
							<form id="updatepasswordForm" class="form-horizontal ls_form bv-form"  >
								<div class="ls_divider">
									<div class="form-group has-feedback">
										<label class="col-lg-3 control-label">旧密码</label>
										<div class="col-lg-6">
											<input type="text" class="form-control" id="oldpassword" name="oldpassword" onblur="checkPassword(this)" placeholder="旧密码">

										</div>
									</div>
								</div>
								<div class="ls_divider">
									<div class="form-group ">
										<label class="col-lg-3 control-label">新密码</label>
										<div class="col-lg-6">
											<input type="password" class="form-control" id="password"  name="password"  >
										</div>
									</div>
								</div>
								<div class="ls_divider">
									<div class="form-group ">
										<label class="col-lg-3 control-label">确认密码</label>
										<div class="col-lg-6">
											<input type="password" class="form-control" name="confirmPassword" >
										</div>
									</div>
								</div>
								<div class="form-group">
									<div class="col-lg-9 col-lg-offset-3" style="margin-top: 10px">
										<button type="submit" onclick="updatePassword();return false;" class="btn btn-success btn-lg">保存</button>
									</div>
								</div>
								<input type="hidden" value="">
							</form>

						</div>

					</div>

				</div>
			</div>
		</div>
	</div>
</div>
</div>



<div class="modal fade" id="settingg" tabindex="-1" role="dialog" aria-labelledby="settingg" aria-hidden="true">
	<div class="modal-dialog  modal-lg">
		<div class="modal-content">
			<div class="modal-header label-light-green white">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">数据统计</h4>
			</div>
			<div class="modal-body" style="padding: 0px">
				<div class="panel" >
					<div class="panel-body" id="panel-body_tab">

						<iframe src="" id="iframepage" frameborder="0" scrolling="auto" marginheight="0" marginwidth="0"  style="margin-left:16px; height:585px; width: 833px;"></iframe>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<!-- diaLog -->
<div class="dialogBox">
	<div class="listBox">
		<div class="row list-group" id="addList" style="height: 560px;overflow-y: auto;">
			<!-- <li class="col-sm-4">
                <span class="list-group-item">
                    <img src="admin/assets/images/webchat/online.png" class="lineImg">
                    名字
                </span>
                <a href="javascript:;"><i class="fa fa-sign-out"></i>转接</a>
            </li> -->
			<!-- yyy
				<table class="table table-bottomless ls-animated-table">
					<thead>
						<tr>
							<th>客户名称</th>
							<th>接待状态</th>
							<th>所属分组</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody class="changeTbody">
						<tr>
							<td>1</td>
							<td class="reqTd2">Mark</td>
							<td class="reqTd3">Otto</td>
							<td>@mdo</td>
							<td>1</td>
							<td class="hide">1</td>
							<td><a href="javascript:;" class="reqBtns">邀请</a></td>
						</tr>
					</tbody>
        		</table>
			-->
		</div>
	</div>
</div>
<!-- audio -->
<audio src="img/14.mp3" id="audio1" style="display:none"></audio>
<audio src="img/15.mp3" id="audio2" style="display: none"></audio>
<!-- diaLog -->
<div class="conLoad" style="display:block;position: absolute;top: 0px;">
	<div class="loading">
		<h2>当前网络不稳定,请检查您的网络.待网络稳定后将自动与服务器建立连接.</h2>
		<img src="img/loading.gif">
	</div>
</div>
<div class="msgBox">
	<div class="callmsgBox clear">
		<div class="fl">
			<p class="userForm">北京电信</p>
			<p class="userNumber">13000000000</p>
		</div>
		<div class="fr">
			<a href="javascript:;" class="callYes">通话完成</a>
			<a href="javascript:;" class="callEnd">未接通</a>
		</div>
	</div>
</div>
<div class="callHtml">
	<!-- <div class="table-responsive ls-table reqTableBox">
        <div class="reqMenuBox clear">
            <div class="fl">
                <button class="btn ls-red-btn">排队中</button>
                <button class="btn ls-light-green-btn">与机器人对话</button>
                <button class="btn ls-light-green-btn">浏览网站中</button>
            </div>
            <div class="fr"> <span class="reqRefNow">刷新于18:09</span> <a href="javascript:;" class="reaRefBtn">刷新</a> </div>
        </div>
        <table class="table table-bottomless ls-animated-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>客户名称</th>
                    <th>最后访问页面</th>
                    <th>最后访问时间</th>
                    <th>停留时间</th>
                    <th class="hide">最后接待客服</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="reqDomBox">
                <tr>
                    <td>1</td>
                    <td class="reqTd2">Mark</td>
                    <td class="reqTd3">Otto</td>
                    <td>@mdo</td>
                    <td>1</td>
                    <td class="hide">1</td>
                    <td><a href="javascript:;" class="reqBtns">邀请</a></td>
                </tr>
            </tbody>
        </table>
        <div class="reqBottom clear">
            <div class="fl">
                <p>显示 <span class="countPage">1</span>/<span class="allCountPage">2</span> 页 总共 <span class="countSize">16</span> 条</p>
            </div>
            <div class="fr">
                <p> <a href="javascript:;" class="reqFirstBtn">首页 </a> <span class="allCountPageBox"> <a href="javascript:;" class="goCountPage">1</a> </span> <a href="javascript:;" class="reaNextBtn">下一页 </a> <a href="javascript:;" class="reqLastBtn">末页 </a>
                    <input type="text" class="reqGoText"> <a href="javascript:;" class="reqGoNumber">跳转</a> </p>
            </div>
        </div>
    </div> -->
</div>



<script src="assets/jslib/color.js"></script>
<script src="assets/jslib/jquery-1.8.3.min.js"></script>
<script src="assets/jslib/bootstrap.min.js"></script>
<script src="assets/jslib/multipleAccordion.js"></script>
<script src="assets/jslib/layout.js"></script>
<script src="assets/jslib/jquery.amaran.js"></script>
<script src="assets/jslib/notify.min.js"></script>
<script src="assets/jslib/bootstrap-switch-new.js"></script>
<script src="assets/jslib/jquery.autosize.js"></script>
<script src="assets/jslib/jquery.remodal.min.js"></script>
<script src="assets/jslib/jquery.Jcrop.js"></script>
<script src="assets/jslib/bootbox.min.js"></script>
<script src="assets/jslib/jquery.slimscroll.min.js"></script>
<script src="js/jquery.nicescroll.js"></script>
<script src="js/zhichichat.js"></script>
<script src="js/face.js"></script>
<script src="js/upload.js?version=20160405"></script>
<script src="js/cut.js"></script>
<script src="js/paste.js"></script>
<script src="assets/jslib/bootstrapValidator.min.js"></script>
<script src="../chatres/common/js/src/app.js"></script>
<script src="js/chat.js?version=20160406"></script>
<script src="js/msg.js?version=20160406"></script>
<script src="js/new.js?version=20160406"></script>



<script type="text/javascript">

</script>

<script type="text/javascript">
	window.Global = window.Global || {};

	var LocString = String(window.document.location.href);
	function getQueryStr(str) {
		var rs = new RegExp("(^|)" + str + "=([^&]*)(&|$)", "gi").exec(LocString), tmp;
		if (tmp = rs) {
			return tmp[2];
		}
		return "";
	}

	var pid ;
	var myid = getQueryStr("id");
	var mylogo ;
	var myname ;
	var status ;
	var isInvite;

	$(function(){
		resizeChat();
		$(".conLoad").show();
		connect();
		bootstrap_validator_call();
		//下拉滚动加载时间注册
		controlScroll();
		//初始化emoji
		/*var i = 0;
		 twemoji.parse(
		 'emoji, m\u2764\uFE0Fn am\u2764\uFE0Fur',
		 function(icon, options, variant) {
		 if (i++ === 0) {
		 alert('初始化1');
		 return; // no changes made first call
		 }
		 alert('初始化2');
		 return '/assets/' + icon + options.ext;
		 }
		 );*/
//		twemoji.parse('I \u2764\uFE0F emoji!');
		inputAddBorder();
	});
	//鼠标移入边框加效果
	function inputAddBorder(){
		$('#profileuser input').on('mouseover',function(){
			$(this).addClass('over');
		}).on('mouseleave',function(){
			$(this).removeClass('over');
		}).on('click',function(){
			$(this).select();
		})
	}
	function resetInfoForm(){
		$('#userinfo_tab a[href="#logo"]').tab('show');

		$('#updatepasswordForm').data('bootstrapValidator').resetForm(true);

	}

	function resetInfoFormtoo(){
		$('#panel-body_tab').tab('show');
		document.getElementById("iframepage").src="census.html?myid="+myid;
	}

	//表单验证触发
	function bootstrap_validator_call(){

		$("#personinfoform").bootstrapValidator({
			message: '字符无效',
			feedbackIcons: {
				valid: 'glyphicon glyphicon-ok',
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
			},
			fields: {
				staffName:{
					validators: {
						notEmpty: {
							message: "真实姓名不能为空"
						}

					}


				},
				nickName:{
					validators: {
						notEmpty: {
							message: "昵称不能为空"
						}
					}
				},
				phone_num: {
					validators: {
						notEmpty: {
							message: "电话不能为空"
						},
						digits: {
							message: '值只能包含数字'
						}
					}
				},
				maxServiceCount: {
					validators: {
						notEmpty: {
							message: "最大接待量不能为空"
						},
						digits: {
							message: '请输入大于等于0的数字'
						}
					}
				}
			}
		});


		$('#updatepasswordForm').bootstrapValidator({
			message: '字符无效',
			feedbackIcons: {
				valid: 'glyphicon glyphicon-ok',
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
			},
			fields: {
				oldpassword: {
					validators: {
						notEmpty: {
							message: '请输入正确的密码'
						},

					}
				},

				password: {
					validators: {
						notEmpty: {
							message: '密码不能为空'
						},
						identical: {
							field: 'confirmPassword',
							message: '两次输入密码不一致'
						}
					}
				},
				confirmPassword: {
					validators: {
						notEmpty: {
							message: '密码不能为空 '
						},
						identical: {
							field: 'password',
							message: '两次输入密码不一致'
						}
					}
				}
			}
		});
	}

	//密码修改旧密码验证
	function checkPassword(e){
		var $field=$(e);
		var field    = $field.attr('data-bv-field');
		var $parent  =  $field.parents('.form-group');
		var $message = $field.data('bv.messages');
		var   $errors  = $message.find('.help-block[data-bv-validator]');
		var  $icon    = $parent.find('.form-control-feedback[data-bv-icon-for="' + field + '"]');
		var $sumButton=$("#updatepasswordForm button");
		$.ajax({
			type : "post",
			url : apihost+"admin/checkAdminForPwd.action",
			dataType : "JSONP",
			data : {
				'uid':myid,
				'oldpasswd':$("#oldpassword").val(),
			},
			success : function (data){
				if(data.valid==true){
					$sumButton.removeAttr('disabled');
					$parent.removeClass('has-error').addClass('has-success');
					$errors.hide();
					$icon.removeClass("glyphicon-remove").addClass("glyphicon-ok");

				}else{
					$sumButton.attr('disabled', 'disabled');
					$parent.removeClass('has-success').addClass('has-error');
					"notEmpty"? $errors.filter('.help-block[data-bv-validator="notEmpty"]').show() : $errors.hide();
					if ($icon) {
						$icon.removeClass("glyphicon-ok").addClass("glyphicon-remove");
					}
				}
			}
		})

	}



	function line(){
		if(status==0){
			//con();
			connect();
		}
		if(status==2){
			online();
		}
	}

	function onlineSuccess(){
		$("#mylogo").attr("src",mylogo);
		$(".previewLogo").attr("src",mylogo);
		$("#current_user_name").html(myname);
		$("#user_offline").show();
		$("#user_busy").show();
		//yy
		$("#user_online").show();
//		$("#user_online").hide();
		$("#connection_icon").attr("src","img/online.png");
		$("#connection_status").html("在线");
		status = 1;
	}

	function offline(){

		bootbox.dialog({
      message: "<div class='offDyy'>请确定是否要下线?</div>",
      buttons: {
        danger: {
          label: "取消",
          className: "btn-danger",
          callback: function() {
          }
        },
        success: {
          label: "确定",
          className: "btn-success",
          callback: function() {
            out();
          }
        }
      }
    });


		// var remodal = $.remodal.lookup[$('[data-remodal-id=remodal_onffline]').data('remodal')];
		// remodal.open();
		/*		if($(".user").hasClass("active")){
		 var remodal = $.remodal.lookup[$('[data-remodal-id=remodal_onffline]').data('remodal')];
		 remodal.open();
		 }else{
		 out();
		 }*/
	}

	function busySuccess(){
		$("#mylogo").attr("src",mylogo);
		$(".previewLogo").attr("src",mylogo);
		$("#current_user_name").html(myname);
		$("#user_offline").show();
		$("#user_busy").show();
//		$("#user_busy").hide();
		$("#user_online").show();
		$("#connection_icon").attr("src","img/busy.png");
		$("#connection_status").html("忙碌");
		status = 2;
	}

	function offlineSuccess(){
		$("#user_offline").show();
//		$("#user_offline").hide();
		$("#user_busy").show();
//		$("#user_busy").hide();
		$("#user_online").show();
		$("#connection_icon").attr("src","img/offline.png");
		$("#connection_status").html("离线");
		$(".user").each(function(){
			var cid = $(this).attr("cid");
			var uid = $(this).attr("uid");
			$("#user_"+uid+"").remove();
			$("#chat_"+uid+"").remove();
		});
		status = 0;
	}


	function userDel(obj){

		var $user = obj.parentNode;

		if( $user.leaved){

			delUser($user);

		}else{
			bootbox.dialog({
				message: "<div class='offDyy'>请确认顾客的问题已经解答，是否结束对话？</div>",
				title: "结束对话",
				buttons: {
					danger: {
						label: "取消",
						className: "btn-danger",
						callback: function() {
						}
					},
					success: {
						label: "确定",
						className: "btn-success",
						callback: function() {
							delUser($user);
						}
					}
				}
			});
		}

		function delUser($user)
		{
			var cid = $($user).attr("cid");
			var uid = $($user).attr("uid");

			if($user.leaved)
			{
				$("#user_"+ uid +"").remove();
				$("#chat_"+ uid +"").remove();
			}
			else
			{
				leave(cid,uid);
			}
		}

		//点击空白处关闭弹窗
		tapCloseWindow();
	}

	function replace_em(str){
		str = str.replace(/\</g,'&lt;');
		str = str.replace(/\>/g,'&gt;');
		str = str.replace(/\n/g,'<br/>');
		str = str.replace(/\[em_([0-9]*)\]/g,'<img src="'+apihost+'chatres/common/emotes/pc/$1.gif"  class="webchat_img_face"/>');
		return str;
	}
	//历史 黑名单用户列表点击   yhw
	$("#historyusers").on("click",".user",function(ev){
		if(ev.target.tagName == "I")return;
		var ishistory=true;
		var This = this;
		/*
		 if(ev.delegateTarget.id=="blackusers"){

		 $("#hchat .addButton .delblack").removeClass("hide");
		 $("#hchat .addButton .delblack").attr("uid",$(this).attr("uid"));
		 ishistory=false;

		 }else{

		 $("#hchat .addButton .delblack").addClass("hide");
		 }
		 */
		if($(".user.active")[0]==This){
			return;
//			alert("same")
		}

		showHistroyChat(this);

	})

	//信息显示
	function showHistroyChat(obj){
		//yy来源
		var source = $(obj).attr("source");
		var uid = $(obj).attr("uid");
		var name = $(obj).attr("name");
		var formIcon = $(obj.children[0]).clone();
		var oHTML = document.createElement('div');
		oHTML.appendChild(formIcon[0]);
		$count = $(obj).children(".msg-count");
		$count.html("");
		$(".user").removeClass("active");
		$(obj).addClass("active");
		$(".chat_user_title").html("<span>"+name+"</span>");
		$(".chat_user_title span").before(oHTML.innerHTML);
		$("#profileuser .formIcon").html(formIcon);
		$(".chat").hide();
		$("#goProfileuser").click();
//		$("#messagesuser").height("100%");
//		$("#messagesuser").height(($("#messagesuser").outerHeight() - 80) + "px");
//		$("#homeuser").height(($("#messagesuser").outerHeight() - 20) + "px");
		//是否在列表中
		if ($("#hchat").attr("uid") == uid) {
			return;
		} else {
			//聊天窗口
			//$chat_new = $("#chat").clone();
			// $chat_new.attr("uid",uid);
			//yy 聊天重置 这里高度只减少5
			resizeChat();
			$("#hchat .panel-body").attr("pagenow",0);
			setHisGet($("#hchat .panel-body")[0],uid,{"type":"black"});
			setScroll($("#hchat"));
			$("#hchat .panel-body").html("");
			disjson(("#hchat .panel-body"),uid,name,$("#hchat"),1,source);   //获取历史记录
			//历史用户无转接按钮
			$("#hchat .transfer").hide();
			$("#hchat").show();
			setScroll($("#hchat"));
		}

		getUserMsg();
		$("#hchat .scrollBoxParent").scrollTop(999999);
		//setScrollWidth($("#hchat_"+uid));
		setTimeout(function(){
			$("#hchat .scrollBox .unread_divider").remove();
		},5000);
	}
	//用户列表点击
	$("#users,#offlineUser").on("click",".user",function(ev){
		if(ev.target.tagName == "I")return;
		var This = this;
		$("#users .user").each(function(i){

			if(this == This){
				return;
			}
			else if(this.leaved)
			{
				var uid = $(this).attr("uid");
				changeUserLi($("#user_"+ uid),"leave",uid);
			}
		});
		showChat(this);

	})
	function showChat(obj){
		//yy usource
		var usource = $(obj).attr("usource");
		var uid = $(obj).attr("uid");
		var name = $(obj).attr("name");
		var formIcon = $(obj.children[0]).clone();
		var oHTML = document.createElement('div');
		oHTML.appendChild(formIcon[0]);
		$count = $(obj).children(".msg-count");
		$count.html("");
		$(".user").removeClass("active");
		$(obj).addClass("active");
		$(".chat_user_title").html("<span>"+name+"</span>");
		$(".chat_user_title span").before(oHTML.innerHTML);
		$("#profileuser .formIcon").html(formIcon);
		$(".chat").hide();
		$("#chat_"+uid).show();

		// 判断是否是第一次点击当前用户
		if (!Global.map[uid].isInitActive) {
			setTimeout(function(){
				$("[data-panel-id='" + uid + "']").scrollTop(999999);
				Global.map[uid].isInitActive = true;
			},200);
		}

		/*dyy判断是否为移动端*/
		$("#homeuser .homeUserBox .robotHide1 .quickSendBtn").css('display','');
		if($(obj).find('i').hasClass('fa-code')){ //这个fa-code  是APP
			/*$("#homeuser .homeUserBox .robotHide1 .quickSendBtn").css('display','none');*/		//移动端
		}

		// if($("#chat_"+uid).find(".scrollBox").children().length == 0)
		// {
		// 	disjson(("#chat_"+uid + " .panel-body"),uid,name,$("#chat_"+uid),1,usource);   //获取历史记录
		// }

		getUserMsg();
		//console.log($('div[uid=' + uid + ']').find('.scrollBoxParent'));
		$('div[uid=' + uid + ']').find('.scrollBoxParent').scrollTop(999999);
		// $("#hchat .scrollBoxParent").scrollTop(999999);
		setScrollWidth($("#chat_"+uid));
		setTimeout(function(){
			$("#chat_"+uid+" .scrollBox .unread_divider").remove();
		},5000);
	}

	function sendMsg(obj){
		$chat = $(obj).closest('.chat')
		var uid = $chat.attr("uid");
		var cid = $chat.attr("cid");
		var content = $(obj).val();
		if(content.trim() == "" || content ==null || content.length>1024){
			$(obj).val('');
			return;
		}
		if($(obj).attr("robot") == "other")
		{
			content = replace_em(content);
		}
		showMsg(uid,myname,mylogo,content);

		$last_msg = $chat.find('.msg_content:last');
		//$last_msg.css("color","gray");
		//s$last_msg.css("color","red");
		$(obj).val("");
		$unread = $chat.find(".unread_divider");
		$unread.remove();
		send(cid,content,function(){
			$last_msg.css("color","");
		}, false, $("[data-panel-id='"+uid+"']").find(".workOrderCus").last());
		$(obj).attr("robot","other");
	}

	function showMsg(uid,name,logoUrl,content,formUser,source, base64file){
		content = content.replace(/&amp;/g,'&');
		///TODO 发送和接收都会调用
		var form = ' ';
		var workOrderCus = 'workOrderCus';
		var float = 'fr';
		var angle = 'angleRight';
		var margin = 'mr';
		if(formUser)
		{
			form = "formUser";
			workOrderCus = 'userCus';
			float = "fl";
			margin = 'ml';
			angle ="angleLeft";
		}


		//在聊天过程中  根据id 去改变最后一条显示消息
		var listMsgLib=content;
		if (content.indexOf('<img') !== -1){
			// 判断是否有表情
			//if (content.indexOf('webchat_img_face') !== -1) {
			//	content = '[表情]';
			//}
			if(content.indexOf('webchat_img_upload') !== -1) {
				listMsgLib = '[图片]';
			}
			else {
				listMsgLib = '[富文本]';
			}
		}
		if(content.indexOf('<audio') !== -1){
			listMsgLib = '[音频]';
		}
		content = ZC_Extend.getUrlRegex(content);
		listMsgLib = listMsgLib.length>8?listMsgLib.toString().substr(0,8).trim() +'...':listMsgLib;

		//根据最后一条类型添加颜色




//		var re = /<img.*?>/g;
//		var reA = /<a.*?<\/a>/g;
//		if(reA.test(lastMsgLib))
//		{
//			lastMsgLib = "[富文本]";
//		}
//		else
//		{
//			if(re.test(lastMsgLib))
//			{
//				if(lastMsgLib.indexOf('webchat_voice')!==-1){
//					alert(lastMsgLib);
//					lastMsgLib= lastMsgLib.replace(re,'[语音]');
//				}else if(lastMsgLib.indexOf("webchat_img_face") !== -1)
//				{
//					lastMsgLib = lastMsgLib.replace(re,"[图片]");
//				}
//			}else{
//				lastMsgLib = content.length>8?content.toString().substr(0,8).trim() +'...':content;
//				lastMsgLib = ZC_Extend.getUrlRegex(lastMsgLib);
//			}
//		}

		$('#users #user_'+uid).find('.lastMsg').html(listMsgLib);
		var dt = new Date().format('hh:mm:ss');
		var msg = '<div class="msg '+workOrderCus+'">'
				+ '<div class="msg_user '+float+'"><img src="'+logoUrl+'" class="msg_user_img"></div>'
				+ '<div class="msgContBox '+float+'"><span class="msg_name">'+name+'</span>'
					//[~]需求修改
//				+ '<span class="msg_time ' + margin + '">' + name.substring(0, 8) + '</span>'
				+ '<span class="msg_time ' + margin + '">' + name + '</span>'
				+ '<span class="msg_time" style="margin-left: 0px;">'+dt+'</span>'
				+ '<div style="clear:both;"></div>'
				+ '<div class="msgBg ' + float + '" style="display: inline-flex;margin: 0px;">'+'<i class="'+angle+'"></i>'+'<div class="msg_content '+ form +'" >'+content+'</div></div></div>'
				+ '</div>';

		$chat = $("#chat_"+uid+" .scrollBox");
		$chat.append(msg);

		var dom = $chat.children().last().find('.upNowImg');

		if (base64file) checkFile(base64file, dom);
		setScroll($("#chat_"+uid));

		// 保存预览图片dom
		$chat.children().last();
	}

	Date.prototype.format = function(format) {
		var o = {
			"M+" : this.getMonth() + 1, // month
			"d+" : this.getDate(), // day
			"h+" : this.getHours(), // hour
			"m+" : this.getMinutes(), // minute
			"s+" : this.getSeconds(), // second
			"q+" : Math.floor((this.getMonth() + 3) / 3), // quarter
			"S" : this.getMilliseconds()
			// millisecond
		}
		if (/(y+)/.test(format)) {
			format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4
					- RegExp.$1.length));
		}
		for (var k in o) {
			if (new RegExp("(" + k + ")").test(format)) {
				format = format.replace(RegExp.$1, RegExp.$1.length == 1  ? o[k]  : ("00" + o[k]).substr(("" + o[k]).length));
			}
		}
		return format;
	}

	function paste_img(file,uid,cid){
		var form = new FormData;
		Global.map[uid].count = Global.map[uid].count || 0;
		Global.map[uid].count++;
		form.append('type', "paste");
		form.append('file', file);
		form.append('pid', pid);
		form.append('source', $("[class='user active']").attr('usource'));
		form.append('countTag', Global.map[uid].count);
		$.ajax({
			//yy去除admin/
			url: apihost+"webchat/fileupload.action",
			type: "POST",
			dataType:"JSONP",
			data: form,
			processData: false,
			contentType: false,
			beforeSend: function() {
			},
			error: function() {
			},
			success: function(response) {
				var url = response.url ,
						con = '<img src="img/upImgLoad.png" class="webchat_img_upload upNowImg">';
				showMsg(uid, myname, mylogo, con, null, null, response.url);
				imgCallBack(uid,url,cid);
			}
		})
	}

	function imgCallBack(uid,url,cid){

		// 当前对话用户的标签
		var obj = $('.mainNav #users .active')
		// ,
		// 		uid = Global.uid || uid,
		// 		cid = Global.cid || cid;

		var resulturl = url.substr(url.lastIndexOf('\.')+1,url.length);
		var resultName = url.substr(url.lastIndexOf('\/')+1,url.length);
		var content = null;
		var msg = null;

		if(resulturl=="jpg"||resulturl=="JPG"||resulturl=="png"||resulturl=="PNG"||resulturl=="gif"||resulturl=="GIF")
		{
			msg = "<img src='"+url+"' class='webchat_img_upload'/>";
			var oImg = document.createElement("img");
			oImg.src = url;
			// 方便出现异常远程调试
			//console.log('图片onload中...');

			oImg.onload = function() {
				$("[data-panel-id='" + uid + "']").scrollTop(999999);
			}

		}else{
			var icon = "icon_default.png";;
			if(resulturl=="txt"||resulturl=="TXT"){
				icon = "icon_txt.gif";
			}
			if(resulturl=="doc"||resulturl=="DOC"||resulturl=="DOCX"||resulturl=="docx"){
				icon = "icon_doc.gif";
			}
			if(resulturl=="ppt"||resulturl=="PPT"||resulturl=="PPTX"||resulturl=="pptx"){
				icon = "icon_ppt.gif";
			}
			if(resulturl=="zip"||resulturl=="ZIP"||resulturl=="rar"||resulturl=="RAR"){
				icon = "icon_rar.gif";
			}
			if(resulturl=="pdf"||resulturl=="PDF"){
				icon = "icon_pdf.gif";
			}
			if(resulturl=="xls"||resulturl=="XLS"||resulturl=="XLSX"||resulturl=="xlsx"){
				icon = "icon_xls.gif";
			}
			content= "<img style='vertical-align: middle; margin-right: 2px;' src='http://img.sobot.com/yun/attachment/fileTypeImages/"+icon+"'><a style='font-size:10px;' target='_black' href='"+url+"'>"+resultName+"</a>";
			msg = "<img style='vertical-align: middle; margin-right: 2px;' src='http://img.sobot.com/yun/attachment/fileTypeImages/"+icon+"'><a  style='font-size:10px;' target='_black' href= '"+url+"'>"+resultName+"</a>";

			$("#chat_"+uid+" .systeamNowText").remove();
			showMsg(uid,myname,mylogo,content);
		}

		send(cid,msg);
		$unread = $("#chat_"+uid+" .unread_divider");
		$unread.remove();
	}
	function showPreview(coords)
	{
		$("#logox").val(coords.x);
		$("#logoy").val(coords.y);
		$("#logow").val(coords.w);
		$("#logoh").val(coords.h);
		if (parseInt(coords.w) > 0)
		{
			var rx = 100 / coords.w;
			var ry = 100 / coords.h;

			var width = boundx;
			var height = boundy;

			$("#preview").css({
				width: Math.round(rx * width) + 'px',
				height: Math.round(ry * height) + 'px',
				marginLeft: '-' + Math.round(rx * coords.x) + 'px',
				marginTop: '-' + Math.round(ry * coords.y) + 'px'
			}).show();
		}
	}

	var cutter;
	var logoImgUpload =  new AjaxUpload($("#logo_btn"), {
		action: apihost+"admin/fileuploadLogo.action",
		name: "file",
		autoSubmit: true,
		data:{uid:myid,type:"logo"},
		responseType:"JSONP",
		onChange: function (file, extension)
		{
			if (!(extension && /^(jpg|JPG|png|PNG|gif|GIF)$/.test(extension))) {
				$.amaran({
					content:{
						message:'格式不支持!',
						size:'请上传png/gif/jpg图片',
						file:'',
						icon:'fa fa-times'
					},
					theme:'default error',
					position:'bottom right',
					inEffect:'slideRight',
					outEffect:'slideBottom'
				});
				return false;
			}
		},
		onSubmit: function (file, extension)
		{
		},
		onComplete: function (file, response)
		{
			var url = response.url;
			cutter = new jQuery.UtrialAvatarCutter({
						content : "jcrop_target",
						purviews : [{id:"preview",width:100,height:100}],
						selector : {width:360,height:360},
						showCoords : function(c) {
							$("#logox").val(c.x);
							$("#logoy").val(c.y);
							$("#logow").val(c.w);
							$("#logoh").val(c.h);
						},
						cropattrs : {boxWidth: 500, boxHeight: 500,keySupport: false,minSize :[100,100]}
					}
			);
			cutter.reload(url);
			$("#logourl").val(url);
			$("#logo_src").show();
			$("#setLogoBtn").show();
		}
	});

	var logoChange = false;
	function setLogo(){
		$.ajax({
			type : "post",
			url : apihost+"admin/setLogo.action",
			dataType : "JSONP",
			data : {
				'uid':myid,
				'url':$("#logourl").val(),
				'x':$("#logox").val(),
				'y':$("#logoy").val(),
				'w':$("#logow").val(),
				'h':$("#logoh").val()
			},
			success : function (data){
				if(data.status=1){
					logoChange = true;
					cutter.destroy();
					$("#setLogoBtn").hide();
					$("#logo_src").hide();
				}
			}
		});
	}

	$('#setting').bind('hidden.bs.modal', function () {
		if(logoChange){
			setTimeout(function () {
				$("#mylogo").attr("src",$("#logourl").val());
				mylogo = $("#logourl").val();
			}, 2000);
		}
	})
	function gerUserinfoByid(){
		$('#personinfoform').data('bootstrapValidator').resetForm(true);
		$.ajax({
			type : "post",
			url : apihost+"admin/queryAdminInfo.action",
			dataType : "JSONP",
			data : {
				'uid':myid,
			},
			success : function (data){
				$("#staffName").val(data.staffName);
				$("#nickName").val(data.nickName);
				$("#phone_num").val(data.tel);
				$("#maxServiceCount").val(data.maxAccept);
			}
		});




	}
	//修改个人信息保存
	function savePersoninfo(){

		//alert($('#personinfoform').bootstrapValidator('validate')[0].noValidate)
		//$('#personinfoform').bootstrapValidator('validate');

		if($('#personinfoform .has-error').size()>0){

			$("#personinfoform button").attr('disabled', 'disabled');
			return;
		}

		$.ajax({
			type : "post",
			url : apihost+"admin/modifyAdminInfo.action",
			dataType : "JSONP",
			data : {
				'uid':myid,
				'staffName':$("#staffName").val(),
				'nickName':$("#nickName").val(),
				'tel':$("#phone_num").val()
			},
			success : function (data){
				var strmsg="个人信息修改失败";
				var datestate="error";
				if(data.status==true){
					strmsg="个人信息修改成功";
					datestate="success";
				}
				$.notify(strmsg,datestate, {
					autoHide: true
				});
			}
		});

	}

	//修改密码
	function updatePassword(){
		if($('#updatepasswordForm .has-error').size()>0){
			("#updatepasswordForm button").attr('disabled', 'disabled');
			return;
		}

		$.ajax({
			type : "post",
			url : apihost+"admin/modifyAdminForPwd.action",
			dataType : "JSONP",
			data : {
				'uid':myid,
				'newpassword':$("#password").val(),
				'oldpasswd':$("#oldpassword").val(),
			},
			success : function (data){
				var strmsg="密码修改失败";
				var datestate="error";
				if(data.status==true){
					strmsg="密码修改成功";
					datestate="success";
				}
				$.notify(strmsg,datestate, {
					autoHide: true
				});


			}
		});
	}


//	var height = $(window).height();
//	$("#left-navigation .mainNav").height(height - 41 + 'px');

	//右侧盒子
	$('.rightBox #profileuser .userInp').not(".othe").focus(function(){
//yy
//		$(this).width("150px");
//end
	});
	//性别
	$('.rightBox #profileuser .userInp#sex').change(function(){
//		var res = $('#sex option:selected').val();
		savaUserText(this);
	})
	$('.rightBox #profileuser .userInp').blur(function(){
		var This = this;
		var isReturn = false;
//yy
//		if($(this).hasClass("othe") == false)
//		{
//			$(this).width("100px");
//		}
//end
		var oStr = $(This).attr("value").replace(/\s/g,"");
		if(oStr.length == 0)
		{
			$(This).parents("li").find("span").hide();
			return;
		}

		function test(reg,oValue,oThis)
		{
			if(oValue != '' && !reg.test(oValue))
			{
				$(oThis).parents("li").find("span").show();
				isReturn = true;
			}
			else
			{
				$(oThis).parents("li").find("span").hide();
			}
		}

		// 用户名
		if($(This).attr("otype") == "uname") {
			var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

     // 	if (nick.trim() === '') {
		 if (nick !='' && nick.length > 28) {
				$(This).parents("li").find("span").show();
				isReturn = true ;
		 	} else {
				$(This).parents("li").find("span").hide();
			}
		}

		// 邮箱
		else if($(This).attr("otype") == "email")
		{
			var reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
			test(reg,This.value,This);
		}

		// qq
		else if($(This).attr("otype") == "qq")
		{
			var reg = /[1-9][0-9]{4,}/;
			test(reg,This.value,This);
		}

		// 电话
		else if($(This).attr("otype") == "tel")
		{
//			var reg = /^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;
			//TODO 放管规则 手机 座机
			var reg = /^[0-9]{12}$/;

			test(reg,This.value,This);
		}
		// 昵称
		else if($(This).attr("otype") == "nick")
		{
			var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

			if (nick !='' && nick.length > 28) {
				$(This).parents("li").find("span").show();
				isReturn = true ;
			} else {
				$(This).parents("li").find("span").hide();
			}
		}
		// 年龄
		else if($(This).attr("otype") == "age")
		{
			var reg = /[1-9][0-9]{1,3}/;
			test(reg,This.value,This);
		}
		//微信
		else if($(This).attr("otype") == "weixin")
		{
			var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

			if (nick !='' && nick.length > 28) {
				$(This).parents("li").find("span").show();
				isReturn = true ;
			} else {
				$(This).parents("li").find("span").hide();
			}
		}
		// 微博
		else if($(This).attr("otype") == "weibo")
		{
			var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

			if (nick !='' && nick.length > 28) {
				$(This).parents("li").find("span").show();
				isReturn = true ;
			} else {
				$(This).parents("li").find("span").hide();
			}
		}
		if(isReturn)
		{
			return;
		}
		else
		{
			savaUserText(this);
		}
	})

	$('.rightBox #profileuser .userInp').keyup(function(ev){
		var oEvent = ev || event;
		var This = this;
		var isReturn = false;

		if(oEvent.keyCode == 13) {



			var oStr = $(This).attr("value").replace(/\s/g,"");
			if(oStr.length == 0)
			{
				$(This).parents("li").find("span").hide();
				return;
			}

			function test(reg,oValue,oThis)
			{
				if(oValue != '' && !reg.test(oValue))
				{
					$(oThis).parents("li").find("span").show();
					isReturn = true;
				}
				else
				{
					$(oThis).parents("li").find("span").hide();
				}
			}

			// 用户名
			if($(This).attr("otype") == "uname") {
				var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

				// if (nick.trim() === '') {
			 if (nick !='' && nick.length > 28) {
					$(This).parents("li").find("span").show();
					isReturn = true ;
			 	} else {
					$(This).parents("li").find("span").hide();
				}
			}

			// 邮箱
			else if($(This).attr("otype") == "email")
			{
				var reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
				test(reg,This.value,This);
			}

			// qq
			else if($(This).attr("otype") == "qq")
			{
				var reg = /[1-9][0-9]{4,}/;
				test(reg,This.value,This);
			}

			// 电话
			else if($(This).attr("otype") == "tel")
			{
				var reg = /^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;
				test(reg,This.value,This);
			}
			// 昵称
			else if($(This).attr("otype") == "nike")
			{
				var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

				if (nick !='' && nick.length > 28) {
					$(This).parents("li").find("span").show();
					isReturn = true ;
				} else {
					$(This).parents("li").find("span").hide();
				}
			}
			// 年龄
			else if($(This).attr("otype") == "age")
			{
				var reg = /[1-9][0-9]{1,3}/;
				test(reg,This.value,This);
			}
			//微信
			else if($(This).attr("otype") == "weixin")
			{
				var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

				if (nick !='' && nick.length > 28) {
					$(This).parents("li").find("span").show();
					isReturn = true ;
				} else {
					$(This).parents("li").find("span").hide();
				}
			}
			// 微博
			else if($(This).attr("otype") == "weibo")
			{
				var nick = This.value ? This.value.replace(/[ ]/g,"") : '';

				if (nick !='' && nick.length > 28) {
					$(This).parents("li").find("span").show();
					isReturn = true ;
				} else {
					$(This).parents("li").find("span").hide();
				}
			}

			if(isReturn)
			{
				return;
			}
			else
			{
				savaUserText(this);
			}



		}
	});
	//保存用户信息
	function savaUserText(obj)
	{
		var type = $(obj).attr("oType"),
				val = $(obj).attr("value"),
				oStr = (type === 'remark' ? val.trim() : type==='sex'?$('#sex option:selected').val():val.replace(/\s/g,"")), // 只有备注不过滤中间的空格  如果是select 要获取选中的value值
		// var oStr = $(obj).attr("value").trim(),
				oNow = $('.mainNav .user.active'),      //当前对话用户的标签
				oUserId = $(oNow).attr('uid'),
				oUrl = apihost+"admin/modify_userinfo.action", // ?uid=" + oUserId + "&" + $(obj).attr("oType") + "=" + oStr;
				flag = false;
		var data = {};



		data.uid = oUserId;
		data.sender = myid;

		if (type) {
			data[type] = oStr;
		}
		//var str=$(obj).attr("oType");
		// var jsonstr='{"uid":"' + oUserId + '","sender":"' + myid + '","' + $(obj).attr("oType") + '":"' + oStr+'"}';
		// var data = $.parseJSON(jsonstr);


		flag = oStr.length === 0;

		$.ajax({
			type:"post",
			url:oUrl,
			data:data,
			dataType:"JSONP",
			success:function(data){

				if($(obj).hasClass("userNameDyy"))
				{
					oNow.name=oStr;


					//完整的
					$(oNow).attr("name",oStr);
					//
					if(/.*[\u4e00-\u9fa5]+.*$/.test(oStr))
					{
						var textLength = 8;
					}
					else
					{
						var textLength = 9;
					}
					if(oStr.length > textLength)
					{
						oStr = oStr.substring(0,textLength) + '...';
					}
					if(oNow[0].leaved){

						//判断状态
						$(oNow).find(".uname").html(oStr+ "[离线]");
						$(oNow).find('.fa-laptop').css('background','#ddd');
						$(oNow).find(".ohide").html(oStr);
						$(".chat_user_title span").html(oStr);

					}else{
						$(oNow).find(".uname,.ohide").html(oStr);
						$(".chat_user_title span").html(oStr);
					}
				}
			}
		})

// 		$.getJSON(oUrl,function(data){
// 			if($(obj).hasClass("userName"))
// 			{
// 				$(oNow).find(".uname,.ohide").html(oStr);
//  				$(".chat_user_title span").html(oStr);
// 			}
// 		});
	}
	//用户列表窗口滚动条
	//$('.leftScroll').slimScroll({height:"500px"});
	$('.leftScroll').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200",horizrailenabled:false});
	$(".msg-send-input").height("54px");
	$("#chatlist").on("blur",".msg-send-input",function(){
		$(this).height("40px");
	})
	$("#chatlist").on("focus",".msg-send-input",function(){
		var This = this;
		setTimeout(function(){
			if($(This).val().length >= 100)
			{
				$(This).height("150px");
			}
			else if($(This).val().length >= 200)
			{
				$(This).height("30px");
			}
			$(This).focusEnd();
		},100)
	})

	//断网
	/*
	 Offline.on("down",function(){
	 $(".conLoad,.conLoad h2").show();
	 });
	 Offline.on("up",function(){
	 $(".conLoad,.conLoad h2").hide();
	 });
	 */



	//START
	//一上来执行一次
	var height = $(window).height();
	var newHeight = $(window).height() -50;
	$("#left-navigation .mainNav").height(newHeight - 80 + 'px');
	//newYY 所有计算样式宽高
	//窗口拉伸
	$(window).resize(function () {

		resizeChat();
		// $(".rightQuickLeft").height('100%');
		$leftNavigation.removeClass('active');
		$navigation.removeClass('active');
		$minWrapper.removeClass('active');
		//getOldMsg 获取历史消息
		if(getOldMsg)
		{
			//获取历史消息
			var oNow = $('.mainNav #users .active');

			//这里是否不应区分 在线列表还是，历史 目前只会对#users 下的
//			var oNow = $('.mainNav #users .active');
			var oUserUid = $(oNow).attr('uid');
			setScrollWidth($("#chat_"+oUserUid));
		}else{

			//在线列表yy
			var oNow = $('.mainNav #users .active');
			//这里是否不应区分 在线列表还是，历史 目前只会对#users 下的
//			var oNow = $('.mainNav #users .active');
			var oUserUid = $(oNow).attr('uid');
//			setScrollWidth($("#chat_"+oUserUid));
			setScroll($("#chat_"+oUserUid));
		}
		$(".msgBox").width($(".rightBox").width()+"px");
	});

	$(".msgBox").width($(".rightBox").width()+"px");
	function resizeChat(){
		var height = $(window).height();
		var newHeight = $(window).height() -50;
		//总窗口
		$("#main-container").height(newHeight + 'px');
		//yy用户窗口高度－顶部客服信息高度 80px
		$("#left-navigation .mainNav").height(newHeight - 80 + 'px');
		//yhw
		//yy用户窗口高度－顶部客服信息高度 80px － 在线，历史 高度 41px
		$("#left-navigation .mainNav .tab-pane.leftScroll").height(newHeight -41-80 + 'px');
		//yy用户好堵－顶部－在线－星标
		$("#historylist").height(newHeight -168 + 'px');
		//yy高度为屏幕最大高度
		$(".chat,#left-navigation").css("height",newHeight+'px');
		$(".right").css("height",newHeight);






		//新加右侧
		$(".rightBox .tab-content").height(newHeight - 52 +'px');
		// //yy 这里对历史用户其作用，因为没有聊天框，所以只减52
		$('.scrollBoxParent').height(newHeight-52+'px');

		$('.animatedTextArea').autosize();



		//智能回复得高度
		$("#homeuser").css('height',newHeight-52 +'px');
		$("#homeuser .homeUserBox").css('height',newHeight-52-40-52 +'px');
		//快捷回复，左，右侧列表
		$('.rightQuickLeft,.rightQuickRight').css('height',newHeight - 52 -80 +'px');
		//iframe
		$("#clientSystem").css('height',newHeight-52 +'px');
		$("#clientSysIframe").css('height',newHeight-52 +'px');
	}







	function resizeChat1(){
		var height = $(window).height();
		var newHeight = $(window).height() -50;
		//总窗口
		$("#main-container").height(newHeight + 'px');
		//yy用户窗口高度－顶部客服信息高度 80px
		$("#left-navigation .mainNav").height(newHeight - 80 + 'px');
		//yhw
		//yy用户窗口高度－顶部客服信息高度 80px － 在线，历史 高度 41px
		$("#left-navigation .mainNav .tab-pane.leftScroll").height(newHeight -41-80 + 'px');
		//yy用户好堵－顶部－在线－星标
		$("#historylist").height(newHeight -168 + 'px');
		//yy高度为屏幕最大高度
		$(".chat,#left-navigation").css("height",newHeight+'px');
		$(".right").css("height",newHeight);

		//新加右侧
		$(".rightBox .tab-content").height(newHeight - 52 +'px');
		$('.animatedTextArea').autosize();

		//智能回复得高度
		$("#homeuser").css('height',newHeight-52 +'px');
		$("#homeuser .homeUserBox").css('height',newHeight-52-40-52 +'px');
		//快捷回复，左，右侧列表
		$('.rightQuickLeft,.rightQuickRight').css('height',newHeight - 52 -80 +'px');
		//iframe
		$("#clientSystem").css('height',newHeight-52 +'px');
		$("#clientSysIframe").css('height',newHeight-52 +'px');
	}



	//滚轮 滚动事件
	//滚动条
	function setScroll(obj){
		$(obj).find('.scrollBoxParent').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});
		setScrollWidth(obj);

		// 增加延迟
		setTimeout(function(){
			$(obj).find('.scrollBoxParent').scrollTop(99999);
		},100)
		// $(obj).find('.scrollBoxParent').scrollTop(99999);
	}

	function setScrollWidth(obj){
		//alert($(obj).width());
		//宽度直接100%
		//$(obj).find('.scrollBoxParent').width($(obj).width()+'px');
		//yy 设置 总高度－ 顶部52  －底部最小210

		//yy 历史记录 高度只是减少52
		if(obj.selector == "#hchat"){
			//历史记录
		}else{
			$(obj).find('.scrollBoxParent').height(($(window).height() - (50 + 52 + 230))+'px');
		}
	}
	//智能回复加滚动条
	$("#homeuser .homeUserBox").niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200",horizrailenabled:false});
	//END

















	//快捷回复
	$("#shortcut").click(function(){
		var oHtml = '<div class="quickBox"><div class="quickLeft col-md-4"><a href="javascript:;" class="quickBtn addGroupBtn"><i class="fa fa-plus"></i>添加新分组</a></div><div class="quickRight col-md-8"><ul class="reply"></ul></div></div>'
		bootbox.dialog({
			size:"large",
			title:"快捷回复",
			message:oHtml
		});


		var oRun = new quickReply();
		oRun.load();
		oRun.disRun();
		//弹出框加滚动条
		//左侧加滚动条
		$('.quickLeft').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});
		//右侧加滚动条
		$('.quickRight').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});

		// 显示滚动条
		setTimeout(function(){
			$(".quickLeft , .quickRight").css({'overflow': 'auto'});
			$(".quickLeft , .quickRight").height('300px');
			// $(".quickRight").css({'overflow': 'auto'});
			// $(".quickRight").height('300px');
		},100);
		//点击空白处关闭弹窗
		tapCloseWindow();
	});
	function quickReply()
	{

		var oLeftDom = '<p class="quickList parentQuick"><input type="text" value="	" placeholder="新分组" maxlength="20" class="groupInput"><a href="javascript:;" class="groupDelet"  style="float: right;">删除</a></p>',
			oRightDom = '<p class="quickList rightQuick"><input type="text" value="" placeholder="新回复" class="quickInput" style="width: 82%;" ><a href="javascript:;" class="quickCancel"  style="float: right;">删除</a><a href="javascript:;" class="quickFirst"  style="float: right;">置顶</a></p>',
			replyDom = '<li class="replyList addNewQuick"><a href="javascript:;" class="quickBtn"><i class="fa fa-plus"></i>添加新回复</a></li>';
		var This = this;
			This.companyId = pid;
			This.inputText="";
			This.leftfocus=false;
			This.load = function(right)
			{

				var getQuickListUrl = apihost+"reply/replyGrouplist.action";
				$.ajax({
					type:"post",
					cache:false,
					data:{
						'userId':myid
					},
					url:getQuickListUrl,
					dataType:"jsonp",
					success:function(data){
						//console.log(data);
						if(!data)
						{
							//This.load();
							if(right){
								$('#messagesuser .rightQuick .rightQuickRight ul').html("");
								$('#messagesuser .rightQuick .rightQuickLeft ul').html("");
							}
							return ;
						}
						if(right)   //刚进入页面
						{
							//console.log(data);
							This.loadRight(data);
						}
						else
						{
							This.disJson(data);
						}

					}
				})
			};
			This.loadRight = function(data)
			{
				$('#messagesuser .rightQuick').html(' ');
				$('#messagesuser .rightQuick').html('<div class="col-md-4 col-xs-4 rightQuickLeft"><ul></ul></div><div class="col-md-8 col-xs-8 rightQuickRight"><ul></ul></div>');
				for(var i = 0 ; i < data.length ; i++)
				{
					var rightLeftDom = '<li groupId="'+ data[i].groupId +'" class="rightLeftBtn">'+ data[i].groupName +'</li>';
					$('#messagesuser .rightQuick .rightQuickLeft ul').append(rightLeftDom);
					$('#messagesuser .rightQuick .rightQuickRight ul').append('<li stype="heigth:30px;" groupId="'+ data[i].groupId +'"></li>');
					for(var j = 0 ;j < data[i]['quickreply'].length ; j++)
					{
						var RightListDom = '<a href="javascript:;" class="quickClick" style="word-wrap: break-word;">'+ data[i].quickreply[j].value +'</a>';
						$('#messagesuser .rightQuick .rightQuickRight ul li[groupId="'+ data[i].groupId +'"]').append(RightListDom);
					}
				}
				This.rightQuick();
				//$('.rightQuick').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});
				//$('.scrollBox').scrollTop(999999);
				//左侧加滚动条
				$('.rightQuickLeft').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});
				//右侧加滚动条
				$('.rightQuickRight').niceScroll({cursorwidth:"10px",mousescrollstep:"100",scrollspeed:"200"});

			};
			//右侧静态事件
			This.rightQuick = function()
			{
				$('#messagesuser .rightQuickLeft').on('click','.rightLeftBtn',function(){
					var oIn = $(this).index();
					$('#messagesuser .rightQuickLeft ul li').removeClass('active');
					$(this).addClass('active');

					$(".rightQuickRight").css({'overflow-y': 'auto'});
					$(".rightQuickRight").height('100%');
					$(".rightQuickRight").css({'overflow': 'hidden'});

					$('#messagesuser .rightQuickRight ul li').hide();
					$($('#messagesuser .rightQuickRight ul li')[oIn]).show();
					$(".rightQuickLeft").height($(".rightQuickRight").height() + 'px');
				});
				$(".rightQuickLeft").height('1px');
				$(".rightQuickRight").height('1px');
				//快捷回复选择语句
				$('#messagesuser .rightQuickRight').on('click','.quickClick',function(ev){
					var ocid = $('#left-navigation .mainNav .leftScroll li .active').attr('cid');
					if(ocid)
					{
						var oSobj = $('#chatlist .chat[cid="'+ ocid+'"] .botTextBox textarea');
						var oSatr = oSobj.val();
						oSobj.val(oSatr + ' ' + $(this).html());
						oSobj.val(oSobj.val().replace("请输入...",""));
						oSobj.focusEnd();
						//TODO 开启可点击表情和发送图片
						$('#maskFace,#maskPhoto').css('display','none');
					}

				});
			}
			This.disJson = function(data)
			{
				$(".quickBox .quickList,.quickBox .replyList").remove();
				This.companyId = data[0].companyId;
				for(var i = 0 ; i < data.length ; i++)
				{	var dataLeftDom = '';
//					if(i==0){
//						 dataLeftDom = '<p class="quickList parentQuick" groupId="'+ data[i].groupId +'"><input type="text" value="'+ data[i].groupName +'" class="groupInput" maxlength="20"><a href="javascript:;" style="float: right;" class="groupDelet">删除</a></p>';
//					}else{
//						 dataLeftDom = '<p class="quickList parentQuick" groupId="'+ data[i].groupId +'"><input type="text" value="'+ data[i].groupName +'" class="groupInput" maxlength="20"><a href="javascript:;" style="float: right;" class="groupDelet">删除</a><a href="javascript:;" style="float: right;" class="groupFirst">置顶</a> </p>';
//					}
					dataLeftDom = '<p class="quickList parentQuick" groupId="'+ data[i].groupId +'"><input type="text" value="'+ data[i].groupName +'" class="groupInput" maxlength="20"><a href="javascript:;" style="float: right;" class="groupDelet">删除</a><a href="javascript:;" style="float: right;" class="groupFirst">置顶</a> </p>';
					$('.quickLeft .quickBtn').before(dataLeftDom);
					var replyLiDom = '<li class="replyList" groupId="'+ data[i].groupId +'"><a href="javascript:;" class="quickBtn"><i class="fa fa-plus"></i>添加新回复</a></li>';
					$('.quickBox .quickRight .reply').append(replyLiDom);

					for(var j = 0 ;j < data[i].quickreply.length ; j++)
					{
						var dataRightDom = '';
//						if(j=0){
//							 dataRightDom = '<p class="quickList rightQuick"><input type="text" style="width: 82%;" value="'+ data[i].quickreply[j].value +'" class="quickInput" quickId="'+ data[i].quickreply[j].id +'" groupId="'+ data[i].quickreply[j].groupId +'"><a href="javascript:;" style="float: right;" class="quickCancel">删除</a></p>';
//						}
//						else{
//							 dataRightDom = '<p class="quickList rightQuick"><input type="text" style="width: 82%;" value="'+ data[i].quickreply[j].value +'" class="quickInput" quickId="'+ data[i].quickreply[j].id +'" groupId="'+ data[i].quickreply[j].groupId +'"><a href="javascript:;" style="float: right;" class="quickCancel">删除</a><a href="javascript:;" style="float: right;" class="quickFirst">置顶</a></p>';
//						}
						dataRightDom = '<p class="quickList rightQuick"><input type="text" style="width: 82%;" value="'+ data[i].quickreply[j].value +'" class="quickInput" quickId="'+ data[i].quickreply[j].id +'" groupId="'+ data[i].quickreply[j].groupId +'"><a href="javascript:;" style="float: right;" class="quickCancel">删除</a><a href="javascript:;" style="float: right;" class="quickFirst">置顶</a></p>';
						$('.quickBox .quickRight .reply .replyList[groupId="'+ data[i].groupId +'"]').find('.quickBtn').before(dataRightDom);
					}
				}
				This.leftfocus=false;
			};

			This.disRun = function(){
				/////事件处理部分
				$('.quickLeft .addGroupBtn').click(function(){
					if(This.leftfocus){
						setTimeout(function(){
							$('.quickLeft .addGroupBtn').click();
						},300)

					}else{
						$(this).before(oLeftDom);
						$('.quickRight .reply').append(replyDom);
						$('.quickRight .reply .replyList').hide();
						//$(this).hide();
						var newDom=$(this).prev();
						newDom.addClass("quickActive");
						newDom.find("input.groupInput").focus();
					}
					//$('.quickRight .reply .replyList:last').show();
				});
				$('.quickRight').on('click','.quickBtn',function(){
					//$(this).hide();
					$(this).before(oRightDom);
					var newDom=$(this).prev();
					//newDom.addClass("quickActive");

					newDom.find("input.quickInput").focus();
				});

				$('.quickLeft').on('mouseover','.parentQuick',function(ev){

					var hasFocus =  $(this).find("input.groupInput").is(':focus');
					if(!hasFocus){
						//$('.quickLeft .quickList').find('a').hide();
						$('.quickBox .quickList').find('a').hide();
						$(this).find('a').show();
					}

				}).on('click','.parentQuick',function(ev){
					if(ev.target.tagName == 'A')
					{
						return;
					}
//					else {
//						var hasFocus =  $(this).find("input.groupInput").is(':focus');
//						if(!hasFocus){
//							//$('.quickLeft .quickList').find('a').hide();
//							$('.quickBox .quickList').find('a').hide();
//							$(this).find('a').show();
//						}
//
//
//					}
					var oIndex = $(this).index();
					$(".quickLeft").css({'overflow': 'auto'});

					$('.quickLeft .quickList').removeClass('quickActive');
					$(this).addClass('quickActive');
					$('.quickRight .replyList').hide();
					if($(this).attr("groupid"))
					{
						$($('.quickRight .replyList')[oIndex]).show();
					}

					$(".bootbox .quickLeft").height($(".bootbox .quickRight").height() + 'px');
				});

				$('.quickRight').on('mouseover','.rightQuick',function(ev){
					//if(ev.target.className == 'groupInput' || ev.target.tagName == 'A')  editor yhw
					if(ev.target.tagName == 'A')
					{
						return;
					}
					else
					{
						var hasFocus =  $(this).find("input.quickInput").is(':focus');
						if(!hasFocus){
							$('.quickRight .quickList').find('a').hide();
							$(this).find('a').show();
						}
					}
		 	});

			  $('.quickBox').on("focus","input",function(ev){

				    $('.quickBox .quickList').find('a').hide();
				    This.inputText=$(this).val();
				    if($(this).parent().hasClass("parentQuick")){
				    	This.leftfocus=true;
				    }
						$(this).nextAll().show();
				});
				//$('.quickRight').on("blur","input",function(ev){
					//$(this).nextAll().hide();
				//});



				//修改分组名,新增分组
				$('.quickLeft').on( "keypress",  "input",(function (e) {
				    var key = e.which;
				    if (key == 13&&!e.shiftKey) {

				    	//SavequickLeftInput(this);
				    	$(this).blur();
				    	return false;
				    }
				}));


				$('.quickLeft').on("blur","input",function(ev){
					var obj=this;
					if($(obj).val().replace(/(^\s*)|(\s*$)/g,"")==""||$(obj).val()==null||$(obj).val()==undefined){
						var oGroupId =$(obj).parent('.parentQuick').attr('groupid');
						//
						if(oGroupId)							//修改分组名
						{
							$(obj).val(This.inputText);

						}else{

							$(obj).parent('.parentQuick').remove();
						}
						This.leftfocus=false;
						return;
					}
					SavequickLeftInput(obj);
				});


				function SavequickLeftInput(obj){
	         		var $this = $(obj);
					var oGroupId = $this.parent('.parentQuick').attr('groupid');
					var groupName = $(obj).val().replace(/(^\s*)|(\s*$)/g,"");
					//$this.html("正在保存...");.siblings('.groupInput')
					if(oGroupId)							//修改分组名
					{
						var upGroupNameUrl = apihost+'reply/updreplyGroup.action';   //?groupId='+ oGroupId +'&&groupName=' + groupName;
						$.ajax({
							type:"post",
							url:upGroupNameUrl,
							data:{
								'groupId':oGroupId,
								'groupName':groupName,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									//$('.quickLeft .addGroupBtn').show();
								//	$this.html("保存");
									//$this.hide();
									 $(obj).val(groupName);
									$this.nextAll().hide()
									This.load(true);
									This.leftfocus=false;
								}
							}
						})
					}
					else						//新增分组
					{
						 var addGroupUrl = apihost+'reply/addreplyGroup.action';//?groupName='+ groupName +'&&userId='+ myid +'&&companyId=' + This.companyId;
						 $.ajax({
							type:"post",
							url:addGroupUrl,
							data:{
								'groupName':groupName,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									$this.nextAll().hide()
									This.load(true);
									This.load();
									setTimeout(function(){
										$('.reply .replyList:last').show();
									},500)

								}
							}
						})
					}




	             }
				//删除分组
				$('.quickLeft').on('click','.groupDelet',function(){

					if(confirm('确定删除该快捷分组?')){
						var $this = $(this);
						var oIndex = $this.parent('.parentQuick').index();
						if($this.parent('.parentQuick').attr('groupid'))
						{
							var groupDeletUrl = apihost+'reply/delreplyGroup.action';
							$.ajax({
								type:"post",
								url:groupDeletUrl,
								data:{
									'groupId':$this.parent('.parentQuick').attr('groupid'),
									'userId':myid
								},
								dataType:"jsonp",
								success:function(data){
									if(data.status)
									{
										$this.parent('.parentQuick').remove();
										$($('.quickRight .reply .replyList').get(oIndex)).remove();

										This.load(true);
									}
								}
							})
						}
						else
						{
							$this.parent('.parentQuick').remove();
						}
						$('.quickLeft .addGroupBtn').show();
					}
				});
				//置顶快捷分组
				$('.quickLeft').on('click','.groupFirst',function(){

					var $this = $(this);
					var oIndex = $this.parent('.parentQuick').index();
					if($this.parent('.parentQuick').attr('groupid'))
					{
						var groupFirstUrl = apihost+'reply/setTopGroup.action';
						$.ajax({
							type:"post",
							url:groupFirstUrl,
							data:{
								'groupId':$this.parent('.parentQuick').attr('groupid'),
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									var that = $this.parent('p')[0];
									$this.parent('p')[0].remove();
									$('.quickLeft.col-md-4').prepend(that);
								}
							}
						})
					}
					else
					{
						$this.parent('.parentQuick').remove();
					}
					$('.quickLeft .addGroupBtn').show();

				})
				//添加修改快速回复

				$('.quickRight').on( "keypress",  "input",(function (e) {
				    var key = e.which;
				    if (key == 13&&!e.shiftKey) {

				    	//SavequickRightInput(this)
				    	$(this).blur();
				    	return false;
				    }
				}));
				$('.quickRight').on("blur","input",function(ev){
					//$('.quickRight').on('click','.quickSave',function(){
					var obj=this;
			       if($(obj).val().replace(/(^\s*)|(\s*$)/g,"")==""||$(obj).val()==null||$(obj).val()==undefined){

			   			var oQuickid =$(obj).attr('quickid');
			   			//
						if(oQuickid)							//修改分组名
						{
							$(obj).val(This.inputText);
						}else{

							$(obj).parent('.quickList').remove();
						}



						return;
					}
					SavequickRightInput(this)
			    });

				function SavequickRightInput(Obj){

					var $this = $(Obj);
					var oInde = $this.parents(".replyList").index();

					var oGroupId = $($('.quickLeft .parentQuick')[oInde]).attr('groupid');
					var oText = $this.val().replace(/(^\s*)|(\s*$)/g,"");
					var oQuickid = $this.attr('quickid');
				   //$this.html("正在保存...");
					if(oQuickid)								//修改
					{
						var changeQuickUrl = apihost+'quick/updquickReply.action';//?id='+ oQuickid +'&&value='+ oText;
						$.ajax({
							type:"post",
							url:changeQuickUrl,
							data:{
								'id':oQuickid,
								'value':oText,
								'userId':myid

							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									//$this.html("保存");
//									$this.
//									console.log($this.nextAll());
									$this.nextAll().hide();
									This.load(true);
									//$this.parents('.reply').find('.quickBtn').show();
								}
							}
						})
					}
					else										//添加
					{
						var addQuickUrl = apihost+'quick/addquickReply.action';//?groupId='+ oGroupId +'&&value='+ oText;
						$.ajax({
							type:"post",
							url:addQuickUrl,
							data:{
								'groupId':oGroupId,
								'value':oText,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									//$this.html("保存");
									//$this.hide();
									$this.attr("quickId",data.id);
									$this.attr("groupId",oGroupId);
									$this.nextAll().hide();
									This.load(true);
									//$this.parents('.reply').find('.quickBtn').show();
								}
							}
						})
					}

				}

				$('.quickRight').on('click','.quickSave',function(){
					var $this = $(this);
					var oInde = $this.parents(".replyList").index();

					var oGroupId = $($('.quickLeft .parentQuick')[oInde]).attr('groupid');
					var oText = $this.siblings('.quickInput').val();
					var oQuickid = $this.siblings('.quickInput').attr('quickid');
					$this.html("正在保存...");
					if(oQuickid)								//修改
					{
						var changeQuickUrl = apihost+'quick/updquickReply.action';//?id='+ oQuickid +'&&value='+ oText;
						$.ajax({
							type:"post",
							url:changeQuickUrl,
							data:{
								'id':oQuickid,
								'value':oText,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									$this.html("保存");
									$this.hide();
									$this.nextAll().hide();
									This.load(true);
									$this.parents('.reply').find('.quickBtn').show();
								}
							}
						})
					}
					else										//添加
					{
						var addQuickUrl = apihost+'quick/addquickReply.action';//?groupId='+ oGroupId +'&&value='+ oText;
						$.ajax({
							type:"post",
							url:addQuickUrl,
							data:{
								'groupId':oGroupId,
								'value':oText,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									$this.html("保存");
									$this.hide();
									$this.nextAll().hide();
									This.load(true);
									$this.parents('.reply').find('.quickBtn').show();
								}
							}
						})
					}
				});
				//删除快速回复
				$('.quickRight').on('click','.quickCancel',function(){

					if(confirm('确定删除该快捷回复答案？')){
						var $this = $(this);
						var oQuickId = $this.siblings('.quickInput').attr('quickid');
						var delQuickUrl = apihost+'quick/delquickReply.action'//?id='+ oQuickId;
						$.ajax({
							type:"post",
							url:delQuickUrl,
							data:{
								'id':oQuickId,
								'userId':myid
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status)
								{
									$this.parent('.quickList').remove();
									This.load(true);
								}
							}
						})
					}

				});
				//置顶快捷回复
				$('.quickRight').on('click','.quickFirst',function(){

					var $this = $(this);
					var oQuickId = $this.siblings('.quickInput').attr('quickid');
					var delQuickUrl = apihost+'quick/setTopReply.action'//?id='+ oQuickId;
					$.ajax({
						type:"post",
						url:delQuickUrl,
						data:{
							'id':oQuickId,
							'userId':myid
						},
						dataType:"jsonp",
						success:function(data){
							if(data.status)
							{
								var that = $this.parent('p');
								$(that).parent('li').prepend(that)
							}
						}
					})

				})
			};
	}

	(new quickReply()).load(true);

	//快捷回复结束
	//$(".rightQuick").height($(window).height() - 76 + 'px');


</script>
<!-- <script src="admin/js/chat.js"></script> -->

<!-- <script src="js/quickReply.js?v=20150828"></script> -->
</body>
</html>
